<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS-4 Robot Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        robot: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            accent: '#3b82f6',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- NippleJS for Joystick -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <style>
        /* Custom Scrollbar for logs */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; }

        /* Sensor bar transitions */
        .sensor-led { transition: all 0.1s ease-out; }
        .status-dot { transition: all 0.15s ease-out; }
        
        /* Glass effect */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }
        .dark .glass-card {
            background-color: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Dragging styles */
        .draggable.dragging { opacity: 0.5; border: 2px dashed #3b82f6; }
        .drop-zone { min-height: 150px; transition: background-color 0.2s; border-radius: 0.75rem; }
        .drop-zone.drag-over { background-color: rgba(59, 130, 246, 0.1); border: 2px dashed rgba(59, 130, 246, 0.3); }
        
        /* Specific drag handles */
        .widget-header { cursor: grab; }
        .widget-header:active { cursor: grabbing; }
        .tab-drag-handle { cursor: grab; }
        .tab-drag-handle:active { cursor: grabbing; }

        /* Tab dragging */
        .tab-btn.dragging { opacity: 0.5; background: #3b82f6 !important; }

        /* Collapsible transitions */
        .widget-content { transition: all 0.3s ease-in-out; overflow: hidden; }
        .collapsed .widget-content { max-height: 0px !important; padding-top: 0 !important; padding-bottom: 0 !important; opacity: 0; }
        .collapsed .collapse-icon { transform: rotate(-90deg); }

        /* Resizable Gutters */
        .gutter-col {
            cursor: col-resize;
            background-color: transparent;
            transition: background-color 0.2s;
            width: 16px; margin: 0 -8px; z-index: 20; position: relative;
        }
        .gutter-col::after {
            content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 2px;
            background-color: rgba(148, 163, 184, 0.2); transition: all 0.2s;
        }
        .dark .gutter-col::after { background-color: rgba(51, 65, 85, 0.5); }
        .gutter-col:hover::after, .gutter-col.active::after { background-color: #3b82f6 !important; width: 4px; }

        /* Drag Locking */
        body.is-resizing { cursor: col-resize !important; user-select: none; }
        body.is-resizing .draggable, body.is-resizing .tab-btn, body.is-resizing iframe { pointer-events: none !important; }

        /* Range Slider Styling */
        input[type=range] {
            @apply h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed;
        }
        input[type=range]::-webkit-slider-thumb {
            @apply appearance-none w-4 h-4 rounded-full bg-blue-500 cursor-pointer transition-all hover:scale-110 hover:bg-blue-400;
        }
        /* Disabled thumb style */
        input[type=range]:disabled::-webkit-slider-thumb {
            @apply bg-slate-400 dark:bg-slate-600 hover:scale-100;
        }

        /* Vertical Slider Transformation */
        .vertical-slider-container {
            display: flex; align-items: center; justify-content: center;
            height: 180px; width: 40px;
        }
        .vertical-slider {
            width: 180px; height: 20px;
            transform: rotate(-90deg);
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0; border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label:after {
             transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-[#0a0f1d] text-slate-800 dark:text-slate-200 font-sans min-h-screen selection:bg-blue-500/30 transition-colors duration-300">

    <!-- Top Navigation Bar -->
    <nav class="border-b border-slate-200 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 backdrop-blur-lg sticky top-0 z-50 transition-colors duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i data-lucide="bot" class="w-8 h-8 text-blue-500 dark:text-blue-400"></i>
                <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">NEXUS-4 <span class="text-slate-500 dark:text-slate-400 font-normal">Dashboard</span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="btn-sim-toggle" class="px-3 py-1 bg-yellow-500/10 text-yellow-600 dark:text-yellow-500 text-xs font-medium rounded-full border border-yellow-500/20 flex items-center hover:bg-yellow-500/20 transition-all" title="Toggle Simulation Mode">
                    <span class="relative flex h-2 w-2 mr-2">
                        <span id="sim-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                    </span>
                    SIMULATION
                </button>
                <button id="btn-connect-toggle" class="flex items-center px-3 py-1 rounded-full bg-red-500/10 text-red-600 dark:text-red-500 text-sm font-medium border border-red-500/20 transition-all hover:bg-red-500/20" title="Click to Reconnect">
                    <i id="conn-icon" data-lucide="wifi-off" class="w-4 h-4 mr-2"></i>
                    <span id="conn-text">Disconnected</span>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 lg:p-6 max-w-[100%] xl:max-w-[1800px]">
        <div id="main-layout" class="flex flex-col xl:flex-row gap-6 xl:gap-0 items-stretch">

            <!-- ZONE 1 (Left) -->
            <div id="zone-1" class="col-zone flex-1 min-w-[300px] space-y-6 drop-zone xl:pr-4">
                <!-- WIDGET: Status Overview -->
                <div id="card-status" class="glass-card rounded-xl p-5 shadow-sm dark:shadow-xl draggable" draggable="false">
                    <div class="widget-header flex justify-between items-center mb-4 p-2 -m-2 rounded-t-xl transition-colors hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                        <h2 class="text-lg font-semibold flex items-center text-slate-900 dark:text-white">
                            <i data-lucide="activity" class="w-5 h-5 mr-2 text-blue-500 dark:text-blue-400"></i> Summary
                        </h2>
                        <div class="flex items-center space-x-2 text-slate-500 dark:text-slate-600">
                            <button class="collapse-trigger hover:text-slate-700 dark:hover:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-5 h-5 collapse-icon transition-transform"></i></button>
                            <i data-lucide="grip-vertical" class="w-5 h-5 opacity-50"></i>
                        </div>
                    </div>
                    <div class="widget-content max-h-[600px]">
                        <div class="space-y-3">
                            <!-- Row 0: Last Updated Timestamp -->
                            <div class="flex justify-between items-center text-xs text-slate-500 dark:text-slate-400 px-1">
                                <span>Last Update:</span>
                                <span id="telemetry-timestamp" class="font-mono">--:--:--.---</span>
                            </div>

                            <!-- Row 1: State & Obstacle Pills -->
                            <div class="flex space-x-2">
                                <!-- State Pill -->
                                <div class="flex-1 bg-slate-200 dark:bg-slate-800 rounded-xl px-3 py-2 flex items-center justify-between">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">State</span>
                                    <span id="telemetry-state-pill" class="text-xs font-black text-blue-500">IDLE</span>
                                </div>
                                <!-- Obstacle Pill -->
                                <div id="obstacle-pill" class="flex-1 bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 rounded-xl px-3 py-2 text-xs font-bold flex items-center justify-center transition-colors">
                                    <i data-lucide="shield-check" class="w-4 h-4 mr-2"></i> CLEAR
                                </div>
                            </div>

                            <!-- Row 2: Metrics Grid (Speed, PWM, Sonar, Servo) -->
                            <div class="grid grid-cols-4 gap-2">
                                 <!-- Speed -->
                                <div class="bg-white/50 dark:bg-slate-900/50 px-2 py-2 rounded-lg border border-slate-200/50 dark:border-slate-800/50 text-center">
                                    <span class="text-[9px] text-slate-400 uppercase block mb-1">Speed</span>
                                    <span id="telemetry-speed" class="font-mono font-bold text-sm block">0.00</span>
                                </div>
                                 <!-- PWM -->
                                <div class="bg-white/50 dark:bg-slate-900/50 px-2 py-2 rounded-lg border border-slate-200/50 dark:border-slate-800/50 text-center">
                                    <span class="text-[9px] text-slate-400 uppercase block mb-1">PWM</span>
                                    <span id="telemetry-pwm" class="font-mono font-bold text-sm block">0</span>
                                </div>
                                 <!-- Sonar -->
                                <div class="bg-white/50 dark:bg-slate-900/50 px-2 py-2 rounded-lg border border-slate-200/50 dark:border-slate-800/50 text-center">
                                    <span class="text-[9px] text-slate-400 uppercase block mb-1">Sonar</span>
                                    <span id="telemetry-sonar" class="font-mono font-bold text-sm block">0</span>
                                </div>
                                 <!-- Servo -->
                                <div class="bg-white/50 dark:bg-slate-900/50 px-2 py-2 rounded-lg border border-slate-200/50 dark:border-slate-800/50 text-center">
                                    <span class="text-[9px] text-slate-400 uppercase block mb-1">Servo</span>
                                    <span id="telemetry-servo" class="font-mono font-bold text-sm block">90</span>
                                </div>
                            </div>
                            
                            <!-- Row 3: Error & IR Summary Pills -->
                            <div class="flex space-x-2">
                                <!-- Error Summary Pill -->
                                <div class="flex-1 bg-white/50 dark:bg-slate-900/50 rounded-xl px-3 py-2 flex items-center justify-between border border-red-500/10 dark:border-red-500/5">
                                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider flex items-center"><i data-lucide="alert-triangle" class="w-3 h-3 mr-1 opacity-50"></i> Errors</div>
                                    <div class="flex space-x-2 text-xs font-mono">
                                         <div class="flex items-center"><span class="w-1.5 h-1.5 rounded-full bg-red-500 mr-1"></span><span id="summary-e2" class="font-bold text-slate-700 dark:text-slate-300">0.0</span></div>
                                         <div class="flex items-center"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 mr-1"></span><span id="summary-e3" class="font-bold text-slate-700 dark:text-slate-300">0.0</span></div>
                                    </div>
                                </div>
                                <!-- IR Status Pill -->
                                <div class="flex-1 bg-white/50 dark:bg-slate-900/50 rounded-xl px-3 py-2 flex items-center justify-between border border-purple-500/10 dark:border-purple-500/5">
                                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider flex items-center"><i data-lucide="scan-eye" class="w-3 h-3 mr-1 opacity-50"></i> IR</div>
                                    <div class="flex items-center space-x-2">
                                        <div id="status-ir-primary" class="flex space-x-0.5"><!-- Dots injected here --></div>
                                        <div class="w-px h-3 bg-slate-300 dark:bg-slate-700"></div>
                                        <div id="status-ir-secondary" class="flex space-x-0.5"><!-- Dots injected here --></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- WIDGET: Master Controls -->
                <div id="card-controls" class="glass-card rounded-xl p-5 shadow-sm dark:shadow-xl relative overflow-hidden draggable" draggable="false">
                    <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                    <div class="widget-header flex justify-between items-center mb-4 p-2 -m-2 rounded-t-xl transition-colors hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                        <h2 class="text-lg font-semibold flex items-center text-slate-900 dark:text-white">
                            <i data-lucide="zap" class="w-5 h-5 mr-2 text-yellow-500 dark:text-yellow-400"></i> Controls
                        </h2>
                         <div class="flex items-center space-x-2 text-slate-500 dark:text-slate-600">
                            <button class="collapse-trigger hover:text-slate-700 dark:hover:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-5 h-5 collapse-icon transition-transform"></i></button>
                            <i data-lucide="grip-vertical" class="w-5 h-5 opacity-50"></i>
                        </div>
                    </div>
                    <div class="widget-content max-h-[600px]">
                        <!-- E-Stop and Mode Toggle Row -->
                        <div class="flex items-stretch space-x-4 mb-6">
                             <!-- E-Stop -->
                            <button id="btn-emergency" class="flex-1 group relative bg-red-600 hover:bg-red-500 text-white p-4 rounded-lg font-bold text-lg flex items-center justify-center transition-all duration-200 active:scale-[0.98] overflow-hidden">
                                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMCAwaDQwdjQwSDB6bTIwIDIwTDAgNDBtNDAgMEwyMCAyMCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjEuNSIgb3BhY2l0eT0iLjEiIGZpbGw9Im5vbmUiLz48L3N2Zz4=')] opacity-20"></div>
                                <i data-lucide="octagon-alert" class="w-6 h-6 mr-3 animate-pulse-fast"></i>E-STOP
                            </button>
                            <!-- Mode Toggle -->
                            <div class="flex flex-col justify-center items-center bg-slate-100 dark:bg-slate-900/50 p-3 px-5 rounded-xl border border-slate-200 dark:border-slate-800">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase">Manual</span>
                                    <label for="mode-toggle" class="relative flex items-center cursor-pointer">
                                        <input type="checkbox" id="mode-toggle" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-emerald-500"></div>
                                    </label>
                                    <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase">Auto</span>
                                </div>
                                <span id="mode-status-text" class="text-xs font-black text-slate-700 dark:text-slate-300">AUTO MODE</span>
                             </div>
                        </div>

                         <!-- 3 Column Control Layout (Swapped Sliders + Joystick) -->
                         <div class="flex justify-between items-center px-1 h-[220px]">
                            
                            <!-- LEFT: Servo Vertical Slider (previously right) -->
                             <div class="flex flex-col items-center space-y-2 z-10">
                                <span class="text-[10px] font-mono text-slate-500 uppercase">Steer</span>
                                <span id="val-servo" class="text-sm font-bold text-orange-500 font-mono mb-2">90°</span>
                                <div class="vertical-slider-container bg-slate-100 dark:bg-slate-900/50 rounded-full border border-slate-200 dark:border-slate-700 py-2">
                                    <input id="slider-servo" type="range" min="0" max="180" value="90" class="vertical-slider accent-orange-500">
                                </div>
                             </div>

                             <!-- CENTER: Joystick Zone -->
                             <div class="flex-1 h-full flex items-center justify-center relative mx-4">
                                <div id="joystick-zone" class="w-full h-full max-w-[200px] max-h-[200px] relative rounded-full bg-slate-100/50 dark:bg-slate-900/30 border-2 border-dashed border-slate-300 dark:border-slate-700">
                                    <!-- NippleJS will inject here -->
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-slate-300 dark:text-slate-700 opacity-50">
                                        <i data-lucide="move" class="w-12 h-12"></i>
                                    </div>
                                </div>
                             </div>

                            <!-- RIGHT: PWM Vertical Slider (previously left) -->
                             <div class="flex flex-col items-center space-y-2 z-10">
                                <span class="text-[10px] font-mono text-slate-500 uppercase">Speed</span>
                                <span id="val-pwm" class="text-sm font-bold text-blue-500 font-mono mb-2">0</span>
                                <div class="vertical-slider-container bg-slate-100 dark:bg-slate-900/50 rounded-full border border-slate-200 dark:border-slate-700 py-2">
                                    <input id="slider-pwm" type="range" min="0" max="255" value="0" class="vertical-slider accent-blue-500">
                                </div>
                             </div>
                         </div>

                    </div>
                </div>
            </div>

            <div class="gutter-col hidden xl:block" data-left="zone-1" data-right="zone-2"></div>

            <!-- ZONE 2 (Center) -->
            <div id="zone-2" class="col-zone flex-1 min-w-[300px] space-y-6 drop-zone xl:px-4">
                 <!-- WIDGET: Live Charts -->
                <div id="card-charts" class="glass-card rounded-xl p-5 shadow-sm dark:shadow-xl draggable" draggable="false">
                    <div class="widget-header flex flex-col sm:flex-row justify-between items-center mb-4 border-b border-slate-200/50 dark:border-slate-800/50 pb-4 p-2 -m-2 rounded-t-xl transition-colors hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                        <div class="flex items-center mb-2 sm:mb-0 mr-auto space-x-4">
                             <h2 class="text-lg font-semibold flex items-center text-slate-900 dark:text-white">
                                 <i data-lucide="activity" class="w-5 h-5 mr-2 text-blue-500 dark:text-blue-400"></i> Telemetry
                            </h2>
                            <!-- Chart Controls -->
                            <div class="flex items-center space-x-1">
                                <button id="btn-chart-hold" class="p-1.5 rounded-md text-slate-500 hover:text-amber-500 hover:bg-amber-500/10 transition-colors" title="Hold/Pause Telemetry">
                                    <i data-lucide="pause" class="w-4 h-4"></i>
                                </button>
                                <button id="btn-chart-refresh" class="p-1.5 rounded-md text-slate-500 hover:text-blue-500 hover:bg-blue-500/10 transition-colors" title="Clear Data & Refresh"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                                <button id="btn-chart-reset" class="p-1.5 rounded-md text-slate-500 hover:text-blue-500 hover:bg-blue-500/10 transition-colors" title="Reset Zoom"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        
                        <div id="tab-container" class="flex space-x-1 bg-slate-200/50 dark:bg-slate-900/50 p-1 rounded-lg mr-4 transition-colors">
                            <button draggable="false" data-tab="ultrasonic" class="tab-btn active group px-3 py-1.5 text-xs font-medium rounded-md transition-all flex items-center space-x-1">
                                <span>Sonar</span>
                            </button>
                            <button draggable="false" data-tab="servo" class="tab-btn group px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 flex items-center space-x-1">
                                <span>Servo</span>
                            </button>
                            <button draggable="false" data-tab="pwm" class="tab-btn group px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 flex items-center space-x-1">
                                <span>Motors</span>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2 text-slate-500 dark:text-slate-600">
                            <button class="collapse-trigger hover:text-slate-700 dark:hover:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-5 h-5 collapse-icon transition-transform"></i></button>
                            <i data-lucide="grip-vertical" class="w-5 h-5 opacity-50"></i>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="widget-content" style="overflow: hidden; height: 400px;">
                        <div class="relative h-full w-full">
                             <div id="ultrasonic-container" class="plot-container absolute inset-0 transition-opacity duration-300">
                                <canvas id="ultrasonic-plot"></canvas>
                                <div class="absolute top-2 right-2 font-mono text-3xl font-bold text-blue-500/80 dark:text-blue-500/80 pointer-events-none"><span id="ultrasonic-live-val">0</span><span class="text-sm ml-1">mm</span></div>
                             </div>
                            <div id="servo-container" class="plot-container absolute inset-0 transition-opacity duration-300 opacity-0 pointer-events-none">
                                <canvas id="servo-plot"></canvas>
                                <div class="absolute top-2 right-2 font-mono text-3xl font-bold text-orange-500/80 pointer-events-none"><span id="servo-live-val">90</span><span class="text-sm ml-1">deg</span></div>
                            </div>
                            <div id="pwm-container" class="plot-container absolute inset-0 transition-opacity duration-300 opacity-0 pointer-events-none">
                                <canvas id="pwm-plot"></canvas>
                                <div class="absolute top-2 right-2 font-mono text-3xl font-bold text-emerald-500/80 pointer-events-none"><span id="pwm-live-val">0</span><span class="text-sm ml-1">pwm</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- WIDGET: Logs -->
                <div id="card-logs" class="glass-card rounded-xl p-4 shadow-sm dark:shadow-xl draggable" draggable="false">
                    <div class="widget-header flex justify-between items-center mb-2 p-2 -m-2 rounded-t-xl transition-colors hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                        <h2 class="text-xs font-semibold text-slate-500 uppercase tracking-wider flex items-center"><i data-lucide="terminal" class="w-4 h-4 mr-2"></i> Logs</h2>
                        
                        <!-- Log Export Controls -->
                        <div class="flex items-center space-x-2 ml-auto mr-4">
                            <!-- MODIFIED: Removed the select dropdown -->
                            <button id="btn-download-logs" class="flex items-center px-2 py-1 bg-blue-500/10 text-blue-600 dark:text-blue-400 text-xs font-medium rounded-md border border-blue-500/20 hover:bg-blue-500/20 transition-colors" title="Download Last 1 Min of Logs">
                                <i data-lucide="download" class="w-3 h-3 mr-1"></i> Export (1 min)
                            </button>
                        </div>

                         <div class="flex items-center space-x-2 text-slate-500 dark:text-slate-600">
                            <button class="collapse-trigger hover:text-slate-700 dark:hover:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-4 h-4 collapse-icon transition-transform"></i></button>
                            <i data-lucide="grip-vertical" class="w-4 h-4 opacity-50"></i>
                        </div>
                    </div>
                    <div class="widget-content max-h-[300px]">
                        <div id="console-log" class="h-32 overflow-y-auto scrollbar-thin font-mono text-[11px] leading-relaxed p-2 bg-slate-100 dark:bg-slate-950/50 rounded-lg border border-slate-200 dark:border-slate-800/50 transition-colors">
                            <div class="text-slate-500">[SYSTEM] Dashboard initialized.</div>
                        </div>
                    </div>
                </div>
            </div>

             <div class="gutter-col hidden xl:block" data-left="zone-2" data-right="zone-3"></div>

            <!-- ZONE 3 (Right) -->
            <div id="zone-3" class="col-zone flex-1 min-w-[300px] space-y-6 drop-zone xl:pl-4">
                 <!-- WIDGET: Sensor Arrays -->
                 <div id="card-sensors" class="glass-card rounded-xl p-5 shadow-sm dark:shadow-xl draggable" draggable="false">
                    <div class="widget-header flex justify-between items-center mb-6 p-2 -m-2 rounded-t-xl transition-colors hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                        <h2 class="text-lg font-semibold flex items-center text-slate-900 dark:text-white"><i data-lucide="scan-eye" class="w-5 h-5 mr-2 text-purple-500 dark:text-purple-400"></i> IR Sensors</h2>
                         <div class="flex items-center space-x-2 text-slate-500 dark:text-slate-600">
                            <button class="collapse-trigger hover:text-slate-700 dark:hover:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-5 h-5 collapse-icon transition-transform"></i></button>
                            <i data-lucide="grip-vertical" class="w-5 h-5 opacity-50"></i>
                        </div>
                    </div>
                    <div class="widget-content" style="overflow: hidden;">
                        <div class="space-y-6 h-full pb-4">
                            <div>
                                <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Primary Array</h3></div>
                                <div class="bg-slate-100 dark:bg-slate-900/80 p-3 rounded-xl border border-slate-200 dark:border-slate-800 flex justify-center space-x-2 h-32 items-end transition-colors" id="sensor-array-container"><!-- JS Injected --></div>
                            </div>
                            <div>
                                 <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Secondary Array</h3></div>
                                <div class="bg-slate-100 dark:bg-slate-900/80 p-3 rounded-xl border border-slate-200 dark:border-slate-800 flex justify-center space-x-2 h-32 items-end transition-colors" id="mid-sensor-array-container"><!-- JS Injected --></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- WIDGET: Error Monitoring -->
                <div id="card-errors" class="glass-card rounded-xl p-5 shadow-sm dark:shadow-xl flex flex-col draggable" draggable="false">
                    <div class="widget-header w-full flex justify-between items-center border-b border-slate-200 dark:border-slate-800 pb-3 mb-4 transition-colors p-2 -m-2 rounded-t-xl hover:bg-slate-200/50 dark:hover:bg-slate-800/50">
                         <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-wider flex items-center">
                             <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i> Error Monitor
                        </h2>
                          <div class="flex items-center">
                               <!-- Chart Controls -->
                            <div class="flex items-center space-x-1 mr-2">
                                <button id="btn-error-refresh" class="p-1.5 rounded-md text-slate-500 hover:text-blue-500 hover:bg-blue-500/10 transition-colors" title="Clear Data"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                                <button id="btn-error-reset" class="p-1.5 rounded-md text-slate-500 hover:text-blue-500 hover:bg-blue-500/10 transition-colors" title="Reset Zoom"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                            </div>

                             <!-- New Toggle for Split/Merged View -->
                             <div class="flex items-center space-x-2 text-slate-500 dark:text-slate-600 border-l border-slate-200 dark:border-slate-700 pl-2">
                                <button id="btn-error-toggle" class="p-1.5 rounded-md hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors" title="Toggle Split/Merged View">
                                    <i data-lucide="layers" class="w-4 h-4"></i>
                                </button>
                                <button class="collapse-trigger hover:text-slate-700 dark:hover:text-slate-300 transition-colors"><i data-lucide="chevron-down" class="w-5 h-5 collapse-icon transition-transform"></i></button>
                                <i data-lucide="grip-vertical" class="w-5 h-5 opacity-50"></i>
                             </div>
                          </div>
                    </div>
                    <div class="widget-content" style="min-height: 300px;">
                           <!-- Error Live Values -->
                           <div class="flex justify-center space-x-8 mb-2 text-sm font-mono">
                               <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>E2: <span id="val-e2" class="font-bold ml-1 text-slate-700 dark:text-slate-300">0.00</span></div>
                               <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>E3: <span id="val-e3" class="font-bold ml-1 text-slate-700 dark:text-slate-300">0.00</span></div>
                           </div>

                          <!-- Container for Merged View (Default) -->
                          <div id="error-mode-merged" class="h-[300px] w-full relative transition-all duration-300">
                               <canvas id="error-merged-plot"></canvas>
                          </div>
                          <!-- Container for Split View (Hidden initially) -->
                          <div id="error-mode-split" class="h-[300px] w-full hidden flex-col space-y-2 transition-all duration-300">
                               <div class="flex-1 relative min-h-0">
                                   <canvas id="error-e2-plot"></canvas>
                               </div>
                               <div class="flex-1 relative min-h-0">
                                   <canvas id="error-e3-plot"></canvas>
                               </div>
                          </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        class Splitter {
            constructor(dashboard) {
                this.dashboard = dashboard;
                this.gutters = document.querySelectorAll('.gutter-col');
                this.activeGutter = null;
                this.init();
            }
            init() {
                this.gutters.forEach(gutter => gutter.addEventListener('mousedown', (e) => this.startDrag(e, gutter)));
                document.addEventListener('mousemove', (e) => this.onDrag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
            }
            startDrag(e, gutter) {
                this.activeGutter = gutter;
                this.activeGutter.classList.add('active');
                this.leftCol = document.getElementById(gutter.dataset.left);
                this.rightCol = document.getElementById(gutter.dataset.right);
                this.startX = e.clientX;
                this.startLeftWidth = this.leftCol.offsetWidth;
                this.startRightWidth = this.rightCol.offsetWidth;
                document.body.classList.add('is-resizing');
            }
            onDrag(e) {
                if (!this.activeGutter) return;
                const deltaX = e.clientX - this.startX;
                const containerWidth = document.getElementById('main-layout').offsetWidth;
                let newLeftPercent = ((this.startLeftWidth + deltaX) / containerWidth) * 100;
                let newRightPercent = ((this.startRightWidth - deltaX) / containerWidth) * 100;
                if (newLeftPercent < 15) { newLeftPercent = 15; newRightPercent = ((this.startLeftWidth + this.startRightWidth) / containerWidth * 100) - 15; } 
                else if (newRightPercent < 15) { newRightPercent = 15; newLeftPercent = ((this.startLeftWidth + this.startRightWidth) / containerWidth * 100) - 15; }
                this.leftCol.style.flex = `${newLeftPercent} 1 0px`;
                this.rightCol.style.flex = `${newRightPercent} 1 0px`;
                this.dashboard.resizeCharts();
            }
            stopDrag() {
                if (this.activeGutter) {
                    this.activeGutter.classList.remove('active');
                    this.activeGutter = null;
                    document.body.classList.remove('is-resizing');
                    this.dashboard.resizeCharts();
                }
            }
        }

        class RobotDashboard {
            constructor() {
                this.ws = null; this.isConnected = false; this.isSimulation = false; 
                this.simInterval = null; this.maxDataPoints = 100; this.updateInterval = 50; 
                this.telemetryHistory = [];
                // MODIFIED: Keep only 1 minute of logs in memory to reduce lag.
                this.maxHistoryRetention = 1 * 60 * 1000; 
                this.errorViewMerged = true; // Track state of error chart view
                this.isTelemetryPaused = false;
                this.joystick = null;
                this.init();
            }
            init() {
                this.bindThemeToggle(); this.initializeCharts(); this.bindEvents(); this.enableDragging(); this.enableCollapsibles(); 
                this.splitter = new Splitter(this); this.initJoystick(); this.connect(); 
            }
            connect() {
                if (this.isConnected) return;
                this.log("[SYSTEM] Attempting to connect...", 'info'); document.getElementById('conn-text').textContent = 'Connecting...';
                try {
                    this.ws = new WebSocket(`ws://${window.location.hostname}/ws`);
                    this.ws.onopen = () => { this.isConnected = true; this.stopSimulation(); this.updateConnectionUI(true); this.log("[SYSTEM] Connection established.", 'success'); };
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.processIncomingData(data);
                        } catch (e) { console.error("Error parsing WS data", e); }
                    };
                    this.ws.onerror = (e) => { console.log("WS Error", e); };
                    this.ws.onclose = () => {
                        if (this.isConnected) this.log("[SYSTEM] Connection lost.", 'error');
                        this.isConnected = false; this.updateConnectionUI(false);
                        if (!this.isSimulation) { this.log("[SYSTEM] Falling back to simulation.", 'warning'); this.startSimulation(); }
                    };
                } catch (e) { this.log("[SYSTEM] Connection failed.", 'error'); this.startSimulation(); }
            }

            initJoystick() {
                const zone = document.getElementById('joystick-zone');
                const options = {
                    zone: zone,
                    mode: 'static',
                    position: { left: '50%', top: '50%' },
                    color: '#3b82f6',
                    size: 120,
                    restOpacity: 0.8
                };
                this.joystick = nipplejs.create(options);
                this.joystick.on('move', (evt, data) => {
                     if (!data.vector) return;
                     // Map Y (Forward/Back) to PWM (0-255)
                     const forward = data.vector.y;
                     let pwm = Math.floor(Math.max(0, forward) * 255);
                    
                     // Map X (Left/Right) to Servo (0-180)
                     const turn = data.vector.x;
                     let servo = Math.floor(90 + (turn * 90));
                     servo = Math.max(0, Math.min(180, servo)); // Clamp
                    
                     // Update Controls UI
                     document.getElementById('slider-pwm').value = pwm;
                     document.getElementById('val-pwm').textContent = pwm;
                     document.getElementById('slider-servo').value = servo;
                     document.getElementById('val-servo').textContent = servo + '°';

                     // Optimistic Update Status UI (Synchronize Telemetry)
                     document.getElementById('telemetry-pwm').textContent = pwm;
                     document.getElementById('telemetry-servo').textContent = servo;
                    
                     // Send Commands
                     this.sendCommand('SET_PWM', { value: pwm });
                     this.sendCommand('SET_SERVO', { value: servo });
                });
                this.joystick.on('end', () => {
                    // Reset Controls UI to neutral
                    document.getElementById('slider-pwm').value = 0;
                    document.getElementById('val-pwm').textContent = '0';
                    document.getElementById('slider-servo').value = 90;
                    document.getElementById('val-servo').textContent = '90°';

                    // Reset Status UI to neutral
                    document.getElementById('telemetry-pwm').textContent = '0';
                    document.getElementById('telemetry-servo').textContent = '90';
                    
                    this.sendCommand('SET_PWM', { value: 0 });
                    this.sendCommand('SET_SERVO', { value: 90 });
                });
            }

            processIncomingData(data) {
                data.timestamp = Date.now();
                this.telemetryHistory.push(data);
                
                // Prune history array
                const cutoff = Date.now() - this.maxHistoryRetention;
                if (this.telemetryHistory.length > 0 && this.telemetryHistory[0].timestamp < cutoff) {
                    const cutoffIndex = this.telemetryHistory.findIndex(d => d.timestamp >= cutoff);
                    if (cutoffIndex > 0) {
                        this.telemetryHistory = this.telemetryHistory.slice(cutoffIndex);
                    }
                }
                // Only update UI if not paused
                if (!this.isTelemetryPaused) {
                    this.updateCharts(data.timestamp, data); 
                    this.updateTelemetry(data);
                    if (data.sensors) {
                        this.renderSensors('sensor-array-container', data.sensors, 'bg-emerald-500');
                        this.renderStatusIR('status-ir-primary', data.sensors, 'bg-emerald-500');
                    }
                    if (data.midSensors) {
                        this.renderSensors('mid-sensor-array-container', data.midSensors, 'bg-blue-500');
                        this.renderStatusIR('status-ir-secondary', data.midSensors, 'bg-blue-500');
                    }
                }
            }

            disconnect() { if (this.ws) this.ws.close(); }
            startSimulation() {
                if (this.isSimulation) return;
                this.isSimulation = true; this.updateSimulationUI(true);
                this.simState = { tick: 0, state: 'IDLE', speed: 0, targetSpeed: 0, obstacleDistance: 2000, servoPos: 90, linePos: 3.5 };
                if (this.simInterval) clearInterval(this.simInterval);
                this.simInterval = setInterval(() => {
                    this.simState.tick += 0.1;
                    // Only run auto-sim logic if NOT in manual state (simple check for now)
                    if (this.simState.state === 'LINE_FOLLOW') { 
                        this.simState.targetSpeed = 0.8; 
                        this.simState.servoPos = 90 + Math.sin(this.simState.tick) * 30; 
                        this.simState.linePos = 3.5 + Math.sin(this.simState.tick * 0.7) * 2.5; 
                    } 
                    else if (this.simState.state === 'IDLE') {
                         this.simState.targetSpeed = 0; 
                    }

                    // Physics update
                    if (this.simState.state === 'MANUAL') {
                        // Instant response in manual mode for better sync feel
                        this.simState.speed = this.simState.targetSpeed;
                    } else {
                        // Inertia for other modes
                        this.simState.speed += (this.simState.targetSpeed - this.simState.speed) * 0.1;
                    }

                    let noise = (Math.random() - 0.5) * 50;
                    // Simulated Error values
                    let e2_sim = Math.sin(this.simState.tick * 0.5) * 10 + (Math.random() - 0.5) * 2;
                    let e3_sim = Math.cos(this.simState.tick * 0.3) * 15 + (Math.random() - 0.5) * 5;

                    this.simState.obstacleDistance = (Math.random() > 0.98) ? 150 : this.simState.obstacleDistance + (2000 - this.simState.obstacleDistance) * 0.05;
                    const generateSensors = (num, center, width) => Array.from({length: num}, (_, i) => Math.min(4095, Math.max(0, Math.floor(4000 * Math.exp(-(Math.abs(i - center) ** 2) / (2 * width ** 2)) + Math.random() * 95))));
                    
                    const mockData = {
                        state: this.simState.obstacleDistance < 300 ? 'OBSTACLE_AVOID' : this.simState.state, 
                        speed: this.simState.speed, 
                        obstacle: this.simState.obstacleDistance < 300,
                        ultrasonic: Math.max(0, this.simState.obstacleDistance + noise), 
                        pwm: this.simState.speed * 255, 
                        // Remove servo noise in MANUAL mode for clean synchronization
                        servoAngle: this.simState.state === 'MANUAL' ? this.simState.servoPos : this.simState.servoPos + (Math.random() - 0.5) * 5,
                        sensors: generateSensors(7, this.simState.linePos, 1.2), 
                        midSensors: generateSensors(7, this.simState.linePos, 1.5),
                        e2: e2_sim, e3: e3_sim
                    };
                    this.processIncomingData(mockData);
                }, this.updateInterval);
            }
            stopSimulation() { this.isSimulation = false; if (this.simInterval) clearInterval(this.simInterval); this.updateSimulationUI(false); }
            updateConnectionUI(connected) {
                const btn = document.getElementById('btn-connect-toggle'); const icon = document.getElementById('conn-icon'); const text = document.getElementById('conn-text');
                btn.className = connected ? "flex items-center px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-600 dark:text-emerald-500 text-sm font-medium border border-emerald-500/20 transition-all hover:bg-emerald-500/20" : "flex items-center px-3 py-1 rounded-full bg-red-500/10 text-red-600 dark:text-red-500 text-sm font-medium border border-red-500/20 transition-all hover:bg-red-500/20";
                text.textContent = connected ? "Connected" : "Disconnected"; icon.setAttribute('data-lucide', connected ? 'wifi' : 'wifi-off'); lucide.createIcons();
            }
            updateSimulationUI(active) {
                document.getElementById('btn-sim-toggle').classList.toggle('opacity-50', !active); document.getElementById('btn-sim-toggle').classList.toggle('grayscale', !active);
                document.getElementById('sim-ping').classList.toggle('hidden', !active);
            }
            bindThemeToggle() {
                this.isDark = document.documentElement.classList.contains('dark'); this.updateChartTheme(this.isDark);
                document.getElementById('theme-toggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); this.isDark = document.documentElement.classList.contains('dark'); this.updateChartTheme(this.isDark); });
            }
            updateChartTheme(isDark) {
                if (!this.charts) return;
                const textColor = isDark ? '#94a3b8' : '#64748b'; const gridColor = isDark ? '#334155' : '#e2e8f0'; 
                Object.values(this.charts).forEach(chart => {
                    chart.options.scales.x.grid.color = gridColor; chart.options.scales.y.grid.color = gridColor;
                    chart.options.scales.x.ticks.color = textColor; chart.options.scales.y.ticks.color = textColor; chart.update('none');
                });
            }
            enableCollapsibles() {
                document.querySelectorAll('.collapse-trigger').forEach(trigger => {
                    trigger.addEventListener('click', (e) => {
                        const card = e.target.closest('.glass-card');
                        if (card) { card.classList.toggle('collapsed'); if (card.id === 'card-charts' && !card.classList.contains('collapsed')) setTimeout(() => this.resizeCharts(), 350); }
                    });
                });
            }
            enableDragging() {
                const setupLockedDrag = (items, handleSelector) => {
                     items.forEach(el => {
                         const handle = el.querySelector(handleSelector);
                         if(!handle) return;
                         handle.addEventListener('mouseenter', () => el.setAttribute('draggable', 'true'));
                         handle.addEventListener('mouseleave', () => el.setAttribute('draggable', 'false'));
                         el.addEventListener('dragstart', (e) => { 
                             if(el.getAttribute('draggable') === 'true') { el.classList.add('dragging'); e.stopPropagation(); } else { e.preventDefault(); }
                         });
                         el.addEventListener('dragend', () => { el.classList.remove('dragging'); this.resizeCharts(); });
                     });
                }
                setupLockedDrag(document.querySelectorAll('.draggable'), '.widget-header');
                setupLockedDrag(document.querySelectorAll('.tab-btn'), '.tab-drag-handle');
                const zones = [...document.querySelectorAll('.drop-zone'), document.getElementById('tab-container')];
                zones.forEach(zone => {
                    zone.addEventListener('dragover', e => {
                        e.preventDefault();
                        const draggingTab = document.querySelector('.tab-btn.dragging');
                        const draggingCard = document.querySelector('.draggable.dragging');
                        if (draggingTab && zone.id === 'tab-container') {
                            const after = this.getDragAfterElementHorizontal(zone, e.clientX); after == null ? zone.appendChild(draggingTab) : zone.insertBefore(draggingTab, after);
                        } else if (draggingCard && zone.classList.contains('drop-zone')) {
                            zone.classList.add('drag-over'); const after = this.getDragAfterElement(zone, e.clientY); after == null ? zone.appendChild(draggingCard) : zone.insertBefore(draggingCard, after);
                        }
                    });
                    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over')); 
                    zone.addEventListener('drop', () => zone.classList.remove('drag-over'));
                });
            }
            getDragAfterElement(container, y) { return [...container.querySelectorAll('.draggable:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
            getDragAfterElementHorizontal(container, x) { return [...container.querySelectorAll('.tab-btn:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = x - box.left - box.width / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; }
            resizeCharts() { if(this.charts) Object.values(this.charts).forEach(chart => chart.resize()); }
            bindEvents() {
                document.getElementById('btn-emergency').addEventListener('click', () => this.handleEmergencyStop());
                document.getElementById('tab-container').addEventListener('click', (e) => { if (e.target.closest('.tab-btn')) this.switchTab(e.target.closest('.tab-btn').dataset.tab); });
                window.addEventListener('resize', () => this.resizeCharts());
                document.getElementById('btn-sim-toggle').addEventListener('click', () => this.isSimulation ? this.stopSimulation() : (this.isConnected ? this.disconnect() : null, this.startSimulation()));
                document.getElementById('btn-connect-toggle').addEventListener('click', () => this.isConnected ? this.disconnect() : this.connect());
                document.getElementById('btn-chart-refresh').addEventListener('click', () => this.refreshCharts());
                document.getElementById('btn-chart-reset').addEventListener('click', () => this.resetChartZoom());
                
                // MODIFIED: Hardcoded to 1 minute, removed select box dependency.
                document.getElementById('btn-download-logs').addEventListener('click', () => { const minutes = 1; this.downloadLogs(minutes); });

                // Chart hold/pause
                document.getElementById('btn-chart-hold').addEventListener('click', (e) => {
                    this.isTelemetryPaused = !this.isTelemetryPaused;
                    const btn = e.currentTarget;
                     if (this.isTelemetryPaused) {
                         btn.classList.add('text-amber-500', 'bg-amber-500/10');
                         btn.querySelector('i').setAttribute('data-lucide', 'play');
                         this.log("[UI] Telemetry PAUSED", 'warning');
                     } else {
                         btn.classList.remove('text-amber-500', 'bg-amber-500/10');
                         btn.querySelector('i').setAttribute('data-lucide', 'pause');
                          this.log("[UI] Telemetry RESUMED", 'info');
                     }
                    lucide.createIcons();
                });

                const pwmSlider = document.getElementById('slider-pwm');
                pwmSlider.addEventListener('input', (e) => {
                     const val = parseInt(e.target.value);
                     document.getElementById('val-pwm').textContent = val;
                     // Sync Status UI
                     document.getElementById('telemetry-pwm').textContent = val;
                     if(this.isSimulation) this.simState.state = 'MANUAL';
                     this.sendCommand('SET_PWM', { value: val });
                });

                const servoSlider = document.getElementById('slider-servo');
                servoSlider.addEventListener('input', (e) => {
                     const val = parseInt(e.target.value);
                     document.getElementById('val-servo').textContent = val + '°';
                     // Sync Status UI
                     document.getElementById('telemetry-servo').textContent = val;
                     if(this.isSimulation) this.simState.state = 'MANUAL';
                     this.sendCommand('SET_SERVO', { value: val });
                });

                // Mode Toggle Event
                document.getElementById('mode-toggle').addEventListener('change', (e) => {
                    const newMode = e.target.checked ? 'AUTO' : 'MANUAL';
                    document.getElementById('mode-status-text').textContent = newMode + " MODE";
                    // Lock/Unlock Manual Controls based on mode
                    this.setManualControls(newMode === 'MANUAL');
                    if (this.isSimulation && newMode === 'MANUAL') this.simState.state = 'IDLE';
                    this.sendCommand('SET_MODE', { mode: newMode });
                    if (this.isSimulation && newMode === 'AUTO') this.simState.state = 'LINE_FOLLOW';
                });

                // Initialize mode display on page load based on default checkbox state
                const initialChecked = document.getElementById('mode-toggle').checked;
                const initialMode = initialChecked ? 'AUTO' : 'MANUAL';
                document.getElementById('mode-status-text').textContent = initialMode + " MODE";
                this.setManualControls(initialMode === 'MANUAL');
                if (this.isSimulation && initialMode === 'AUTO') this.simState.state = 'LINE_FOLLOW';

                // Error view toggle
                document.getElementById('btn-error-toggle').addEventListener('click', () => {
                    this.errorViewMerged = !this.errorViewMerged;
                    const icon = document.querySelector('#btn-error-toggle i');
                    icon.setAttribute('data-lucide', this.errorViewMerged ? 'layers' : 'grid');
                    lucide.createIcons();
                    
                    document.getElementById('error-mode-merged').classList.toggle('hidden', !this.errorViewMerged);
                    document.getElementById('error-mode-merged').classList.toggle('flex', this.errorViewMerged); // Use flex to ensure full height if needed
                    document.getElementById('error-mode-split').classList.toggle('hidden', this.errorViewMerged);
                    document.getElementById('error-mode-split').classList.toggle('flex', !this.errorViewMerged);
                    
                    this.resizeCharts();
                });

                // New: Error Chart Controls
                document.getElementById('btn-error-refresh').addEventListener('click', () => this.refreshErrorCharts());
                document.getElementById('btn-error-reset').addEventListener('click', () => this.resetErrorChartZoom());
            }

            // Helper to disable/enable manual controls
            setManualControls(enabled) {
                const sliders = [document.getElementById('slider-pwm'), document.getElementById('slider-servo')];
                sliders.forEach(slider => slider.disabled = !enabled);
                // We don't strictly need to disable joystick, nipplejs might have an option, but CSS pointer-events can work too
                document.getElementById('joystick-zone').style.pointerEvents = enabled ? 'auto' : 'none';
                document.getElementById('joystick-zone').style.opacity = enabled ? '1' : '0.5';

                if (!enabled) {
                    // Reset sliders to default on AUTO mode
                    document.getElementById('slider-pwm').value = 0;
                    document.getElementById('val-pwm').textContent = '0';
                    document.getElementById('slider-servo').value = 90;
                    document.getElementById('val-servo').textContent = '90°';
                }
            }

            handleEmergencyStop() { this.log("[EMERGENCY] STOP triggered!", 'error'); this.sendCommand('EMERGENCY_STOP'); }
            
            sendCommand(cmd, params = {}) {
                // Throttle generic move commands to avoid spamming if needed
                if (cmd !== 'SET_PWM' && cmd !== 'SET_SERVO' && cmd !== 'JOYSTICK_MOVE') {
                     this.log(`[CMD] Sending: ${cmd.toUpperCase()} ${JSON.stringify(params)}`);
                }

                if (this.isConnected && this.ws) {
                    this.ws.send(JSON.stringify({ command: cmd, ...params }));
                } else if (this.isSimulation) {
                    if(cmd === 'SET_MODE') {
                         if(params.mode === 'AUTO') this.simState.state = 'LINE_FOLLOW';
                         else if(params.mode === 'MANUAL') this.simState.state = 'IDLE';
                    }
                    if(cmd === 'SET_PWM') {
                        this.simState.targetSpeed = params.value / 255; 
                    }
                    if(cmd === 'SET_SERVO') this.simState.servoPos = params.value;
                }
            }
            
            downloadLogs(minutes) {
                const cutoff = Date.now() - (minutes * 60 * 1000);
                const logsToExport = this.telemetryHistory.filter(entry => entry.timestamp >= cutoff);
                if (logsToExport.length === 0) { this.log(`[SYSTEM] No logs found for last ${minutes} minute(s).`, 'warning'); return; }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logsToExport, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `telemetry_log_${new Date().toISOString().replace(/[:.]/g, '-')}.json`);
                document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
                this.log(`[SYSTEM] Exported ${logsToExport.length} data points (${minutes}m).`, 'success');
            }

            log(msg, type = 'info') {
                const logContainer = document.getElementById('console-log'); const entry = document.createElement('div');
                entry.innerHTML = `<span class="text-slate-400 dark:text-slate-600">[${new Date().toLocaleTimeString().split(' ')[0]}]</span> ${msg}`;
                entry.className = type === 'error' ? 'text-red-600 dark:text-red-400' : type === 'warning' ? 'text-yellow-600 dark:text-yellow-400' : type === 'success' ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300';
                logContainer.appendChild(entry); logContainer.scrollTop = logContainer.scrollHeight;
            }
            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const isActive = btn.dataset.tab === tabName;
                    btn.classList.toggle('active', isActive);
                    btn.classList.toggle('bg-blue-100', isActive && !this.isDark); btn.classList.toggle('text-blue-600', isActive && !this.isDark);
                    btn.classList.toggle('bg-blue-500/20', isActive && this.isDark); btn.classList.toggle('text-blue-400', isActive && this.isDark);
                    if (!isActive) { btn.classList.remove('bg-blue-100', 'text-blue-600', 'bg-blue-500/20', 'text-blue-400'); btn.classList.add('text-slate-500', 'dark:text-slate-400'); } else { btn.classList.remove('text-slate-500', 'dark:text-slate-400'); }
                });
                ['ultrasonic', 'servo', 'pwm'].forEach(type => { const c = document.getElementById(`${type}-container`); type === tabName ? c.classList.remove('opacity-0', 'pointer-events-none') : c.classList.add('opacity-0', 'pointer-events-none'); });
            }
            initializeCharts() {
                const initialGrid = '#334155'; const initialText = '#94a3b8';
                const commonOptions = {
                    responsive: true, maintainAspectRatio: false, animation: false, parsing: false,
                    scales: { 
                        x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, display: true, grid: { color: initialGrid }, ticks: { maxRotation: 0, autoSkip: true, color: initialText } }, 
                        y: { grid: { color: initialGrid }, beginAtZero: true, ticks: { color: initialText } } 
                    },
                    plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'nearest', intersect: false }, zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy' } } },
                    elements: { point: { radius: 0, hoverRadius: 5 }, line: { tension: 0.4, borderWidth: 2 } }
                };
                const createChart = (id, label, color, max) => {
                    const ctx = document.getElementById(id).getContext('2d');
                    const grad = ctx.createLinearGradient(0, 0, 0, 350); grad.addColorStop(0, `${color}80`); grad.addColorStop(1, `${color}00`);
                    return new Chart(ctx, { type: 'line', data: { datasets: [{ label, borderColor: color, backgroundColor: grad, fill: true, data: [] }] }, options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max } } } });
                }
                this.charts = { 
                    ultrasonic: createChart('ultrasonic-plot', 'Distance', '#3b82f6', 2000), 
                    servo: createChart('servo-plot', 'Angle', '#f97316', 180), 
                    pwm: createChart('pwm-plot', 'PWM', '#10b981', 255) 
                };
                this.chartData = { ultrasonic: [], servo: [], pwm: [], e2: [], e3: [] };

                // Init Error Charts
                const errorOptions = JSON.parse(JSON.stringify(commonOptions)); // deep copy
                delete errorOptions.scales.y.beginAtZero; // Errors can be negative
                
                // Merged Chart (2 Datasets)
                this.charts.errorMerged = new Chart(document.getElementById('error-merged-plot').getContext('2d'), {
                     type: 'line', data: { datasets: [
                         { label: 'E2 Error', borderColor: '#ef4444', backgroundColor: '#ef444420', data: [] },
                         { label: 'E3 Error', borderColor: '#3b82f6', backgroundColor: '#3b82f620', data: [] }
                     ]}, options: errorOptions
                });
                // Split Charts (1 Dataset each)
                this.charts.errorE2 = new Chart(document.getElementById('error-e2-plot').getContext('2d'), {
                     type: 'line', data: { datasets: [{ label: 'E2 Error', borderColor: '#ef4444', backgroundColor: '#ef444420', fill: true, data: [] }]}, options: errorOptions
                });
                 this.charts.errorE3 = new Chart(document.getElementById('error-e3-plot').getContext('2d'), {
                     type: 'line', data: { datasets: [{ label: 'E3 Error', borderColor: '#3b82f6', backgroundColor: '#3b82f620', fill: true, data: [] }]}, options: errorOptions
                });

            }
            refreshCharts() { Object.keys(this.chartData).forEach(k => this.chartData[k] = []); Object.values(this.charts).forEach(c => { if(c.data && c.data.datasets) { c.data.datasets.forEach(ds => ds.data = []); c.update(); }}); this.log("Charts cleared.", 'info'); }
            resetChartZoom() { Object.values(this.charts).forEach(c => c.resetZoom()); }
            
            // NEW: Error Chart specific refresh/reset
            refreshErrorCharts() {
                this.chartData.e2 = [];
                this.chartData.e3 = [];
                [this.charts.errorMerged, this.charts.errorE2, this.charts.errorE3].forEach(c => {
                    c.data.datasets.forEach(ds => ds.data = []);
                    c.update();
                });
                this.log("Error charts cleared.", 'info');
            }
            resetErrorChartZoom() {
                [this.charts.errorMerged, this.charts.errorE2, this.charts.errorE3].forEach(c => c.resetZoom());
            }

             updateCharts(timestamp, data) {
                const pushData = (type, val, chartObj, datasetIndex = 0) => {
                    this.chartData[type].push({x: timestamp, y: val});
                    if (this.chartData[type].length > this.maxDataPoints) this.chartData[type].shift();
                    if (chartObj) {
                        chartObj.data.datasets[datasetIndex].data = this.chartData[type];
                        chartObj.update('none');
                    }
                };
                if (data.ultrasonic !== undefined) { pushData('ultrasonic', data.ultrasonic, this.charts.ultrasonic); document.getElementById('ultrasonic-live-val').textContent = data.ultrasonic.toFixed(0); }
                if (data.servoAngle !== undefined) { pushData('servo', data.servoAngle, this.charts.servo); document.getElementById('servo-live-val').textContent = data.servoAngle.toFixed(0); }
                if (data.pwm !== undefined) { pushData('pwm', data.pwm, this.charts.pwm); document.getElementById('pwm-live-val').textContent = data.pwm.toFixed(0); }
                
                // Update Error Charts (all of them, so they are ready when toggled)
                if (data.e2 !== undefined) {
                     this.chartData.e2.push({x: timestamp, y: data.e2});
                     if (this.chartData.e2.length > this.maxDataPoints) this.chartData.e2.shift();
                     this.charts.errorMerged.data.datasets[0].data = this.chartData.e2;
                     this.charts.errorE2.data.datasets[0].data = this.chartData.e2;
                }
                if (data.e3 !== undefined) {
                     this.chartData.e3.push({x: timestamp, y: data.e3});
                     if (this.chartData.e3.length > this.maxDataPoints) this.chartData.e3.shift();
                     this.charts.errorMerged.data.datasets[1].data = this.chartData.e3;
                     this.charts.errorE3.data.datasets[0].data = this.chartData.e3;
                }
                // Only update visible error charts to save resources
                if (this.errorViewMerged) this.charts.errorMerged.update('none');
                else { this.charts.errorE2.update('none'); this.charts.errorE3.update('none'); }
            }

            renderSensors(containerId, sensors, colorClass = 'bg-emerald-500') {
                const container = document.getElementById(containerId);
                if (container.children.length !== sensors.length) {
                    container.innerHTML = '';
                    sensors.forEach(() => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'flex-1 bg-slate-200 dark:bg-slate-800 rounded-md relative overflow-hidden flex items-end group h-full transition-colors';
                        wrapper.innerHTML = `<div class="sensor-led w-full ${colorClass} opacity-80 transition-all duration-150"></div><span class="absolute bottom-0.5 left-0 right-0 text-center text-[9px] font-bold text-slate-900/70 dark:text-white/80 mix-blend-overlay z-10"></span>`;
                        container.appendChild(wrapper);
                    });
                }
                Array.from(container.children).forEach((wrapper, i) => {
                    const val = sensors[i];
                    wrapper.firstElementChild.style.height = `${Math.min(100, (val / 4095) * 100)}%`;
                    wrapper.lastElementChild.textContent = val;
                    wrapper.firstElementChild.classList.toggle('shadow-[0_0_15px_rgba(16,185,129,0.6)]', val > 2400);
                    wrapper.firstElementChild.classList.toggle('brightness-125', val > 2400);
                });
            }

            // Render small dots for Status Summary
            renderStatusIR(containerId, sensors, colorClass) {
                const container = document.getElementById(containerId);
                if (container.children.length !== sensors.length) {
                    container.innerHTML = '';
                    sensors.forEach(() => {
                        const dot = document.createElement('div');
                        dot.className = 'w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-700 status-dot';
                        container.appendChild(dot);
                    });
                }
                Array.from(container.children).forEach((dot, i) => {
                    const isActive = sensors[i] > 2400; // Hardcoded threshold for summary (adjusted for 4095 max)
                    // Reset classes
                    dot.className = 'w-2 h-2 rounded-full status-dot ' + (isActive ? colorClass + ' shadow-sm' : 'bg-slate-300 dark:bg-slate-700');
                });
            }

             updateTelemetry(data) {
                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    const timeStr = date.toLocaleTimeString('en-GB', { hour12: false }) + '.' + String(date.getMilliseconds()).padStart(3, '0');
                    document.getElementById('telemetry-timestamp').textContent = timeStr;
                }
                if (data.state) {
                    const el = document.getElementById('telemetry-state-pill');
                    el.textContent = data.state.replace('_', ' ');
                    // Reset classes then add specific ones
                    el.className = 'text-xs font-black';
                    switch(data.state) {
                        case 'IDLE': el.classList.add('text-blue-500'); break;
                        case 'LINE_FOLLOW': el.classList.add('text-emerald-500'); break;
                        case 'OBSTACLE_AVOID': el.classList.add('text-yellow-500'); break;
                        case 'EMERGENCY': el.classList.add('text-red-500', 'animate-pulse'); break;
                        case 'MANUAL': el.classList.add('text-purple-500'); break;
                        default: el.classList.add('text-slate-500');
                    }
                }
                if (data.speed !== undefined) document.getElementById('telemetry-speed').textContent = data.speed.toFixed(2);
                if (data.pwm !== undefined) document.getElementById('telemetry-pwm').textContent = data.pwm.toFixed(0);
                if (data.ultrasonic !== undefined) document.getElementById('telemetry-sonar').textContent = data.ultrasonic.toFixed(0);
                if (data.servoAngle !== undefined) document.getElementById('telemetry-servo').textContent = data.servoAngle.toFixed(0);
                
                // Update Error Monitoring Values
                if (data.e2 !== undefined) {
                    document.getElementById('val-e2').textContent = data.e2.toFixed(2);
                    document.getElementById('summary-e2').textContent = data.e2.toFixed(1);
                }
                if (data.e3 !== undefined) {
                    document.getElementById('val-e3').textContent = data.e3.toFixed(2);
                    document.getElementById('summary-e3').textContent = data.e3.toFixed(1);
                }

                if (data.obstacle !== undefined) {
                     const obEl = document.getElementById('obstacle-pill');
                     if(data.obstacle) { 
                         obEl.innerHTML = '<i data-lucide="shield-alert" class="w-4 h-4 mr-2"></i> DETECTED'; 
                         obEl.className = "flex-1 bg-red-500/10 text-red-600 dark:text-red-400 rounded-xl px-3 py-2 text-xs font-bold flex items-center justify-center transition-colors animate-pulse"; 
                     } else { 
                         obEl.innerHTML = '<i data-lucide="shield-check" class="w-4 h-4 mr-2"></i> CLEAR';
                         obEl.className = "flex-1 bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 rounded-xl px-3 py-2 text-xs font-bold flex items-center justify-center transition-colors"; 
                     }
                     lucide.createIcons(); // Refresh icons in pill
                }
            }
        }
        document.addEventListener('DOMContentLoaded', () => { window.dashboard = new RobotDashboard(); window.dashboard.switchTab('ultrasonic'); });
    </script>
</body>
</html>