<!DOCTYPE html>
<html>
<head>
    <title>Robot Dashboard - Local Test</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .telemetry-card {
            padding: 15px;
            background: var(--light);
            border-radius: var(--border-radius);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .telemetry-card:hover {
            transform: translateY(-3px);
        }
        
        .telemetry-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
            margin: 5px 0;
        }
        
        .telemetry-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .sensor-container {
            padding: 20px 0;
        }
        
        .sensor-array {
            display: flex;
            align-items: flex-end;
            height: 150px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 10px;
            background: var(--light);
            position: relative;
        }
        
        .sensor-segment {
            flex: 1;
            margin: 0 3px;
            background: #ced4da;
            border-radius: 3px;
            position: relative;
            min-width: 20px;
            transition: height 0.2s ease;
        }
        
        .sensor-segment.black { background: #495057; }
        .sensor-segment.white { background: #f8f9fa; border: 1px solid #adb5bd; }
        
        .sensor-value {
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.7em;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); color: #212529; }
        
        .btn-emergency {
            background: #e74c3c !important;
            grid-column: span 3;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-init { background: #6c757d; color: white; }
        .status-idle { background: var(--info); color: white; }
        .status-line-follow { background: var(--success); color: white; }
        .status-avoid { background: var(--warning); color: #212529; }
        .status-stop { background: var(--danger); color: white; }
        .status-lost { background: #fd7e14; color: white; }
        
        .obstacle-detected { color: var(--danger); font-weight: bold; }
        .obstacle-clear { color: var(--success); }
        
        .connection-status {
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .sensor-info {
            margin-top: 10px;
            font-size: 0.85em;
            color: #6c757d;
            text-align: center;
        }
        
        .demo-controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .demo-controls button {
            margin: 5px;
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>[ROBOT] ESP32 Line-Following Robot Dashboard</h1>
            <p>Real-time monitoring and control system (Local Demo)</p>
        </header>
        
        <div id="connection-status" class="connection-status status-connected">
            CONNECTED to Robot (Demo Mode)
        </div>
        
        <div class="dashboard-grid">
            <section class="panel">
                <h2>Telemetry Data</h2>
                <div class="telemetry-grid">
                    <div class="telemetry-card">
                        <div class="telemetry-label">Speed</div>
                        <div id="speed-value" class="telemetry-value">0.00 m/s</div>
                    </div>
                    <div class="telemetry-card">
                        <div class="telemetry-label">Battery</div>
                        <div id="battery-value" class="telemetry-value">8.40 V</div>
                    </div>
                    <div class="telemetry-card">
                        <div class="telemetry-label">State</div>
                        <div id="state-value" class="telemetry-value">
                            <span id="state-indicator" class="status-indicator status-idle">IDLE</span>
                        </div>
                    </div>
                    <div class="telemetry-card">
                        <div class="telemetry-label">Obstacle</div>
                        <div id="obstacle-value" class="telemetry-value obstacle-clear">No</div>
                    </div>
                </div>
            </section>
            
            <section class="panel">
                <h2>Robot Controls</h2>
                <div class="controls-grid">
                    <button id="forward-btn" class="btn btn-primary">FORWARD (↑)</button>
                    <button id="left-btn" class="btn btn-primary">LEFT (←)</button>
                    <button id="right-btn" class="btn btn-primary">RIGHT (→)</button>
                    <button id="start-btn" class="btn btn-success">START</button>
                    <button id="stop-btn" class="btn btn-warning">STOP</button>
                    <button id="emergency-btn" class="btn btn-emergency">EMERGENCY STOP</button>
                </div>
            </section>
        </div>
        
        <section class="panel sensor-container">
            <h2>Sensor Array</h2>
            <div id="sensor-array" class="sensor-array"></div>
            <p class="sensor-info">Sensor values: lower = black line detected, higher = white surface</p>
        </section>
        
        <div class="panel demo-controls">
            <h3>Demo Controls</h3>
            <button id="simulate-data">Generate Random Sensor Data</button>
            <button id="simulate-state">Cycle Robot States</button>
            <button id="simulate-obstacle">Toggle Obstacle Detection</button>
        </div>
    </div>

    <script>
        // DemoRobotDashboard class - Modified for local demo
        class DemoRobotDashboard {
            constructor() {
                this.isConnected = true;
                this.currentSensorIndex = 0;
                this.currentStateIndex = 0;
                this.obstacleDetected = false;
                
                // Initialize with default values
                this.robotData = {
                    sensors: [500, 500, 500, 500, 500, 500, 500],
                    speed: 0.0,
                    battery: 8.40,
                    state: 'IDLE',
                    obstacle: false
                };
                
                this.availableStates = [
                    { name: 'INIT', class: 'status-init' },
                    { name: 'IDLE', class: 'status-idle' },
                    { name: 'LINE_FOLLOW', class: 'status-line-follow' },
                    { name: 'AVOID_PREPARE', class: 'status-avoid' },
                    { name: 'AVOID_PATH', class: 'status-avoid' },
                    { name: 'MERGE_SEARCH', class: 'status-avoid' },
                    { name: 'TURN_LEFT_PREPARE', class: 'status-line-follow' },
                    { name: 'SLOW_DOWN', class: 'status-line-follow' },
                    { name: 'STOP', class: 'status-stop' },
                    { name: 'LOST_LINE', class: 'status-lost' }
                ];
                
                this.init();
            }
            
            init() {
                this.bindEventListeners();
                this.renderSensorArray();
                
                // Start auto-updating demo data
                setInterval(() => this.updateDemoData(), 1000);
            }
            
            bindEventListeners() {
                // Control buttons - show feedback when clicked
                document.getElementById('forward-btn').addEventListener('click', () => {
                    this.showControlFeedback('Forward command sent!');
                    this.updateSpeed(0.5);
                });
                
                document.getElementById('left-btn').addEventListener('click', () => {
                    this.showControlFeedback('Left command sent!');
                });
                
                document.getElementById('right-btn').addEventListener('click', () => {
                    this.showControlFeedback('Right command sent!');
                });
                
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.showControlFeedback('Start command sent!');
                    this.updateState('LINE_FOLLOW');
                });
                
                document.getElementById('stop-btn').addEventListener('click', () => {
                    this.showControlFeedback('Stop command sent!');
                    this.updateState('IDLE');
                });
                
                document.getElementById('emergency-btn').addEventListener('click', () => {
                    this.showControlFeedback('Emergency stop sent!');
                    this.updateState('STOP');
                    this.updateSpeed(0.0);
                });
                
                // Demo controls
                document.getElementById('simulate-data').addEventListener('click', () => {
                    this.generateRandomSensorData();
                });
                
                document.getElementById('simulate-state').addEventListener('click', () => {
                    this.cycleRobotState();
                });
                
                document.getElementById('simulate-obstacle').addEventListener('click', () => {
                    this.toggleObstacle();
                });
            }
            
            showControlFeedback(message) {
                alert(message);
            }
            
            updateDemoData() {
                // Simulate changing sensor values
                this.generateRandomSensorData();
                
                // Occasionally change state
                if (Math.random() > 0.7) {
                    this.cycleRobotState();
                }
                
                // Occasionally change speed
                if (Math.random() > 0.6) {
                    this.robotData.speed = Math.random() * 1.5;
                    this.updateTelemetry();
                }
            }
            
            generateRandomSensorData() {
                // Generate more realistic sensor data with some correlation
                const center = Math.floor(Math.random() * 7); // Random center position for line
                const variance = 50 + Math.random() * 100;
                
                this.robotData.sensors = this.robotData.sensors.map((_, index) => {
                    // Make the center sensor more likely to detect the line (lower value)
                    if (index === center) {
                        return Math.max(100, 300 - Math.random() * variance);
                    } else if (Math.abs(index - center) === 1) {
                        // Adjacent sensors have medium chance of detecting
                        return Math.max(200, 400 - Math.random() * variance/2);
                    } else {
                        // Other sensors have higher values (white surface)
                        return 500 + Math.random() * 300;
                    }
                });
                
                this.updateSensorArray();
            }
            
            cycleRobotState() {
                this.currentStateIndex = (this.currentStateIndex + 1) % this.availableStates.length;
                const newState = this.availableStates[this.currentStateIndex];
                this.updateState(newState.name);
            }
            
            toggleObstacle() {
                this.obstacleDetected = !this.obstacleDetected;
                this.robotData.obstacle = this.obstacleDetected;
                this.updateTelemetry();
            }
            
            updateState(stateName) {
                this.robotData.state = stateName;
                this.updateTelemetry();
            }
            
            updateSpeed(newSpeed) {
                this.robotData.speed = newSpeed;
                this.updateTelemetry();
            }
            
            updateTelemetry() {
                // Update speed
                document.getElementById('speed-value').textContent = this.robotData.speed.toFixed(2) + ' m/s';
                
                // Update battery - stays constant in demo
                document.getElementById('battery-value').textContent = this.robotData.battery.toFixed(2) + ' V';
                
                // Update state
                const stateIndicator = document.getElementById('state-indicator');
                stateIndicator.textContent = this.robotData.state;
                
                // Find the appropriate CSS class for the state
                const stateObj = this.availableStates.find(s => s.name === this.robotData.state);
                if (stateObj) {
                    stateIndicator.className = 'status-indicator ' + stateObj.class;
                }
                
                // Update obstacle status
                const obstacleValue = document.getElementById('obstacle-value');
                obstacleValue.textContent = this.robotData.obstacle ? 'Yes' : 'No';
                obstacleValue.className = this.robotData.obstacle ? 'telemetry-value obstacle-detected' : 'telemetry-value obstacle-clear';
            }
            
            updateSensorArray() {
                // Update the sensor visualization
                this.renderSensorArray();
            }
            
            renderSensorArray() {
                const sensorArrayEl = document.getElementById('sensor-array');
                sensorArrayEl.innerHTML = '';
                
                this.robotData.sensors.forEach((value, index) => {
                    const segment = document.createElement('div');
                    segment.className = 'sensor-segment';
                    
                    // Set height based on sensor value (inverted: lower value = more reflection = black line)
                    const heightPercent = Math.min(100, (1023 - value) / 1023 * 100);
                    segment.style.height = heightPercent + '%';
                    
                    // Add color class based on threshold
                    if (value < 500) {
                        segment.classList.add('black');
                    } else {
                        segment.classList.add('white');
                    }
                    
                    // Add sensor value label
                    const valueLabel = document.createElement('div');
                    valueLabel.className = 'sensor-value';
                    valueLabel.textContent = value;
                    segment.appendChild(valueLabel);
                    
                    sensorArrayEl.appendChild(segment);
                });
            }
        }
        
        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DemoRobotDashboard();
        });
    </script>
</body>
</html>